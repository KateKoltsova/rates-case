# API для отримання поточного курсу долара

## Цей API має наступний функціонал:

- Отримує поточний курс(-и) за допомогою сторонніх відкритих API.
  Наразі реалізована взаємодія з Монобанк та Приватбанк, за замовченням використовується Приватбанк;
- Зберігає отриманий курс долара до БД MySQL;
- Підписує на щоденну розсилку емейли, надіслані за спеціальним запитом.

##### Якщо курс отримати не вдалось з якихось причин, то для розсилки використовується останній актуальний курс.

### Для початку тестування API необхідно:

- створити файл _**`.env`**_ за зразком _**`.env.example`**_ у папці _`/rates-case/src`_;
- створити файл _**`mysql.env`**_ за зразком _**`mysql.env.example`**_ у папці _`/rates-case`_;
- запустити _`docker-compose run`_.

Команди докера встановлюють необхідні залежності та сервіси, а також запускають міграції.

Запущений сервер доступний за адресою _**`http://localhost:8080/`**_.

View за вказаним посиланням наразі налаштована тільки у вигляді форми з запитом на додавання ємейлу до розсилки, без валідації та дуже примітивна.

Також у репозиторії міститься `rates-case.postman_collection.json` із шаблонами запитів для додавання ємейлу та отримання поточного та останнього актуалього курсу долара та прикладами відповіде API.

Для перевірки відправки листів на емейл необхідно у вашому створеному файлі _**`.env`**_ закоментувати рядок _`MAIL_MAILER=log`_, розкоментувати змінні _`MAIL`_ та підставити в них дані вашого SMTP-серверу, або нічого не змінювати - тоді листи буде записано у файл _`/rates-case/src/storage/logs/laravel.log`_.
 
Далі треба перейти у консоль, зайти у контейнер докеру командою _**`docker-compose exec php /bin/sh`**_, перейти у директорію проекту командою _**`cd ../rates-case/src`**_ запустити по черзі команди _**`php artisan schedule:run`**_ і _**`php artisan queue:work --queue=rate_subscribers_notification`**_, або запускати ці дві команди з різних консолей.

Або можна запустити в одній консолі _`queue:work`_, а в іншій відкрити tinker _**`php artisan tinker`**_ і запустити івент командою _**`App\Events\CurrencyRateUpdatedEvent::dispatch('рандомний-курс')`**_.

Розсилка налаштована на 8му ранку за UTC кожного дня, щоб протестувати роботу шедулера ви можете у файлі _`/rates-case/src/app/Console/Kernel.php`_ у рядку 20 змінити _**`dailyAt('08:00')`**_ наприклад на _**`everyTwoMinutes()`**_. Відповідно треба буде дочекатись дві хвилини до команди _`schedule:run`_.